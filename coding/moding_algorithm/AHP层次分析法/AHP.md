# 层次分析法(AHP)

## （一）GUIDANCE

### 1.1 适用场景

全称“层次权重决策分析方法”，一种解决多目标的复杂问题的定性与定量相结合的决策分析方法

在对复杂的决策问题的本质、影响因素及其内在关系等进行深入分析的基础上，利用较少的定量信息使决策的思维过程数学化，从而为多目标、多准则或无结构特性的复杂决策问题提供简便的决策方法

### 1.2 原理

1. 层次分析法根据问题的性质和要达到的总目标，将问题分解为不同的组成因素，并按照因素间的相互关联影响以及隶属关系将因素按不同层次聚集组合，形成一个多层次的分析结构模型，从而最终使问题归结为最低层（方案、措施层）相对于最高层（总目标层）的相对重要权值的确定或相对优劣次序的排定。
2. 一致矩阵法的合理性：矩阵的一致程度越强，说明我们对不同因素的重要性做出的评估的“矛盾程度”越小，说明我们作出评估越准确

---

## （二）模型步骤

### 2.1 步骤一：建立层次结构模型

1） 确定最高层（总目标）、中间层（考虑的因素）、最低层（等待评估&选择的方案），这三个层又被称为目标层、准则层和方案层

   > 事实上，准则层可以不只有一层，如果定的准则超过 9 个，一般我们选择进一步分出子准则层。
   
2） 作图方法：`vscode` 插件 `Draw.io Integration`，如下：

   <center><img src = images/ahpio1.png width = 55%></center>

### 2.2 步骤二：定性分析&定性计算得到准则层判断矩阵

1） 收集资料，对于准则层提出的各种准则的重要程度有一定的判断依据

2） 作出判断矩阵

   |          | 价格     | 距离     | 口味     | 等待时间 | 餐厅装潢 |
   | -------- | -------- | -------- | -------- | -------- | -------- |
   | 价格     | $a_{11}$ | $a_{12}$ | $a_{13}$ | $a_{14}$ | $a_{15}$ |
   | 距离     | $a_{21}$ | $a_{22}$ | $a_{23}$ | $a_{24}$ | $a_{25}$ |
   | 口味     | $a_{31}$ | $a_{32}$ | $a_{33}$ | $a_{34}$ | $a_{35}$ |
   | 等待时间 | $a_{41}$ | $a_{42}$ | $a_{43}$ | $a_{44}$ | $a_{45}$ |
   | 餐厅装潢 | $a_{51}$ | $a_{52}$ | $a_{53}$ | $a_{54}$ | $a_{55}$ |
   

3） 两两进行互相比较分析（而不是把所有因素放在一起比较）
   
   - 一般而言，我们使用下面的标度方法：

      | $a_{ij}值$   | 含义                           |
      | ------------ | ------------------------------ |
      | 1            | 因素 $i$ 和因素 $j$ 重要性相同 |
      | 3            | 因素 $i$ 比因素 $j$ 稍微重要   |
      | 5            | 因素 $i$ 比因素 $j$ 明显重要   |
      | 7            | 因素 $i$ 比因素 $j$ 强烈重要   |
      | 9            | 因素 $i$ 比因素 $j$ 极端重要   |
      | 2, 4, 6, 8   | 中间值                         |
      | 上述值的倒数 | $a_{ij} {a_{ji}} = 1$          |
    
4） 比较过程中尽量考虑相对尺度，以提高准确度

   - 首先应该满足的是判断矩阵是一个正互矩阵：即满足 $a_{ij} {a_{ji}} = 1$
   - 其次应该考虑作出的判断不应该明显有悖于已经作出的判断
   - 判断矩阵的标度应该优先考虑题目中给出的信息和严谨的学术论文给出

   严格遵循上面两个原则，我们给出判断矩阵各个方格中应该填的值
  
  |          | 价格          | 距离          | 口味          | 等待时间 | 餐厅装潢 |
  | -------- | ------------- | ------------- | ------------- | -------- | -------- |
  | 价格     | $1$           | $1$           | $\frac{1}{3}$ | $2$      | $2$      |
  | 距离     | $1$           | $1$           | $\frac{1}{3}$ | $2$      | $2$      |
  | 口味     | $3$           | $3$           | 1             | $6$      | $6$      |
  | 等待时间 | $\frac{1}{2}$ | $\frac{1}{2}$ | $\frac{1}{6}$ | 1        | $1$      |
  | 餐厅装潢 | $\frac{1}{2}$ | $\frac{1}{2}$ | $\frac{1}{6}$ | 1        | $1$      |

   > 由于我们遵循的判断标准非常严苛，我们发现上表有这样的特点：价格的标度是口味的标度 $\frac{1}{3}$ ，等待时间的标度是口味的 $\frac{1}{6}$ ，而价格的标度**刚好**是等待时间标度的 $2$ 倍，换句话说，即便在不同的因素之间，它们的重要程度也严格遵循相对尺度（$a_{ij}a_{jk} = a_{ik}$）
   >
   > 上面的说明也许使人困惑，但还可以这样理解：两两互相比较，这要求我们进行 $\frac{n(n-1)}{2}$ 次判断，但是由于严谨的标准，这 $\frac{n(n-1)}{2}$ 次判断的效果和只用同一个变量得到所有其它变量标度的效果一致
   >
   > 但是事实上我们给出的判断并不总是那么准确，有可能会出现变量不完全满足相对尺度的情形，这时我们需要通过对判断矩阵进行一致性检验来测算出现的误差是否在我们可以接受的范围内

### 2.3 步骤三：对判断矩阵进行一致性检验

符号定义：

判断矩阵的最大特征根记为 $\lambda$ ，判断矩阵的规模（行数）记为 $n$ ，判断矩阵的一致性指标 $CI$ （衡量判断矩阵的一致性程度），随机一致性指标 $RI$ （一个通过查已知表得到的值），一致性比率 $CR$

1） 求出最大特征根 $\lambda$ 
   
2） 求出矩阵的一致性指标 $CI$ 

 $$CI = \frac{\lambda - n}{n-1}$$

3） 查表得到随机一致性指标 $RI$ 
   
  | $n$  | 1   | 2   | 3    | 4    | 5    | 6    | 7    | 8    | 9    | 10   | 11   |
  | ---- | --- | --- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
  | $RI$ | 0   | 0   | 0.58 | 0.90 | 1.12 | 1.24 | 1.32 | 1.41 | 1.45 | 1.49 | 1.51 |

4） 求出一致性比率 $CR$ 
   
  $$ CR  = \frac{CI}{RI}$$

  > 一般情况下我们认为一致性比率 $CR < 0.1$时，它的不一致程度在我们的允许范围内

### 2.4 步骤四：求解判断矩阵权重向量

求解权重向量一般有三种方法，可以全部使用，然后互相检验

前置知识：什么时向量归一化？

$(a_1,a_2,\dots,a_n)$ 归一化后为 $(\frac{a_1}{a_1+a_2+\dots+a_n},\frac{a_2}{a_1+a_2+\dots+a_n},\dots,\frac{a_1}{a_1+a_2+\dots+a_n})$

- 算术平均法

步骤：先将列向量全部归一化，再求解每一行的算术平均值，将这些算术平均值整合成一个列向量，再将这个列向量进行归一化，就能得到权重向量。

权重向量的第 $i$ 个分量为 $w_i$

$$
      w_i = \frac{1}{n}\sum_{j = 1}^{n}\frac{a_{ij}}{\sum_{k=1}^na_{kj}}
$$

- 几何平均法

步骤：计算每一行的几何平均值（这个方法不需要先进行归一化），将这些几何平均值整合成一个列向量，再将这些向量进行归一化，就能得到权重向量。

权重向量的第 $i$ 个分量为 $w_i$

$$
      w_i = \frac{(\prod_{j=1}^na_{ij})^\frac{1}{n}}{\sum_{k=1}^{n}(\prod_{j=1}^na_{kj})^\frac{1}{n}}
$$

- 特征根法

可以根据 2.5 的内容（一致矩阵的性质 3 ）得知：事实上一致的判断矩阵的最大特征值对应的特征向量可以直接视为第一列向量各分量的 k 倍（ k 是一个常数），将它归一化以后就是权重向量

这样，在一致性可以接受的情况下，我们只要求出最大特征值对应的特征向量，也能用来表示权重向量

步骤：求出判断矩阵的最大特征值对应的特征向量，将这个特征向量直接进行归一化得到权重向量

### 2.5 求解各个方案在不同因素下的权重向量

使用如上描述的三种方法，同样可以列出各个方案在不同因素下的权重向量，如下我们依旧先给出方案层的判断矩阵

 | 价格     | 东区二楼 | 西区一楼 | 中区二楼 |
 | -------- | -------- | -------- | -------- |
 | 东区二楼 | $a_{11}$ | $a_{12}$ | $a_{13}$ |
 | 西区一楼 | $a_{21}$ | $a_{22}$ | $a_{23}$ |
 | 中区二楼 | $a_{31}$ | $a_{32}$ | $a_{33}$ |

 | 距离     | 东区二楼 | 西区一楼 | 中区二楼 |
 | -------- | -------- | -------- | -------- |
 | 东区二楼 | $a_{11}$ | $a_{12}$ | $a_{13}$ |
 | 西区一楼 | $a_{21}$ | $a_{22}$ | $a_{23}$ |
 | 中区二楼 | $a_{31}$ | $a_{32}$ | $a_{33}$ |

   | 口味     | 东区二楼 | 西区一楼 | 中区二楼 |
   | -------- | -------- | -------- | -------- |
   | 东区二楼 | $a_{11}$ | $a_{12}$ | $a_{13}$ |
   | 西区一楼 | $a_{21}$ | $a_{22}$ | $a_{23}$ |
   | 中区二楼 | $a_{31}$ | $a_{32}$ | $a_{33}$ |
  
  | 等待时间 | 东区二楼 | 西区一楼 | 中区二楼 |
  | -------- | -------- | -------- | -------- |
  | 东区二楼 | $a_{11}$ | $a_{12}$ | $a_{13}$ |
  | 西区一楼 | $a_{21}$ | $a_{22}$ | $a_{23}$ |
  | 中区二楼 | $a_{31}$ | $a_{32}$ | $a_{33}$ |

 | 食堂装潢 | 东区二楼 | 西区一楼 | 中区二楼 |
 | -------- | -------- | -------- | -------- |
 | 东区二楼 | $a_{11}$ | $a_{12}$ | $a_{13}$ |
 | 西区一楼 | $a_{21}$ | $a_{22}$ | $a_{23}$ |
 | 中区二楼 | $a_{31}$ | $a_{32}$ | $a_{33}$ |

根据这五个表格，可以经过 2.4 列举的三种方法求解出五个一维权重向量，它们分别代表东区二楼、西区一楼和中区二楼在五个不同因素下的评分。

### 2.6 将准则层和方案层的权重向量整合到一个表格中，进行最终评估
现在，我们可以根据已经求得的所有数据列出下面的表格

|          | 因素权重 | 东区二楼                 | 西区一楼                 | 中区二楼                 |
| -------- | -------- | ------------------------ | ------------------------ | ------------------------ |
| 价格     | $w_1$    | $a_{11}$                 | $a_{12}$                 | $a_{13}$                 |
| 距离     | $w_2$    | $a_{21}$                 | $a_{22}$                 | $a_{23}$                 |
| 口味     | $w_3$    | $a_{31}$                 | $a_{32}$                 | $a_{33}$                 |
| 等待时间 | $w_4$    | $a_{41}$                 | $a_{42}$                 | $a_{43}$                 |
| 食堂装潢 | $w_5$    | $a_{51}$                 | $a_{52}$                 | $a_{53}$                 |
| 最终得分 |          | $\sum_{i=1}^5 a_{i1}w_i$ | $\sum_{i=1}^5 a_{i2}w_i$ | $\sum_{i=1}^5 a_{i3}w_i$ |

只需要比较 $\sum_{i=1}^5 a_{i1}w_i$ 、$\sum_{i=1}^5 a_{i2}w_i$ 和 $\sum_{i=1}^5 a_{i3}w_i$ 的大小就能作出评估

### 2.6 一点补充（可以不看）：为什么我们这么在意最大特征值

我们对一致矩阵作出如下的定义：满足 $a_{ij}a_{jk} = a_{ik},1 \le i,j,k \le n$ 的矩阵被我们称为一致矩阵

> 从这个定义中我们可以知道“一致”意味着什么：我们在作出两两比较判断的全过程严格遵照尺度（可以认为有一个严格遵循的标准）

 一致矩阵的性质
  
  1）  一致矩阵的秩为 $1$ ，且一致矩阵任意两行之间成比例
  
  2）  一致矩阵的最大特征根为 $tr(判断矩阵) = n$ ，即判断矩阵的迹，其它特征根均为 0 
  
  3）  判断矩阵的最大特征值对应的特征向量为 $X = (\frac{k}{a_{11}},\frac{k}{a_{12}},\dots,\frac{k}{a_{1n}})^T$，其中 $k$ 为常数

我们来不严格地理解一下这些性质

- 对于性质 1 

由于一致矩阵有严格遵循的标准，换言之，我们知道 A 和 B 、C 、D之间的关系，自然也能够得到 B 和 C，B 和 D，C 和 D之间的关系，只需要第一行的信息就能够补充完整整个判断矩阵的内容。

整个判断矩阵中的有效信息只有第一行的信息，第一行以外的其它行的信息都能够被第一行的信息表示，因此一致矩阵的秩为 1

- 对于性质 2 

显然由于判断矩阵的对角线元素均为 $1$ ，故 $tr(判断矩阵) = n$

设判断矩阵为 $P$ ，满足 $PX = kX$，即 $(P-kI)X=O$

取 $k = 0$ 时，得到 $PX = O$，我们知道 $r(P) = 1$，那么显然 X 的基础解系的秩为 $n - 1$（自由未知量的个数） 

那么 $k = 0$ 这一特征根的几何重数为 $n-1$，显然其代数重数大于等于 $n-1$ 且小于 $n$

> 几何重数永远小于等于代数重数

如果 $k = 0$ 这一特征根代数重数为 $n$ ，显然不能满足特征值的和为 $tr(P) = n$ ，因此它的代数重数为 $n-1$

剩下的一个特征根必然为 $tr(P) - 0 - 0 - \dots - 0 = tr(P) = n$

- 对于性质 3
  
$\dots$ $\dots$ 开摆

> 综上，我们已经得到一个一致矩阵的最大特征值为 $n$ ，事实上，如果一个判断矩阵的最大特征值越接近 $n$ ，我们会认为它越接近一致的状态

### 2.7 局限

- 考虑的因素和对象不能过多：平均随机一致性指标 $RI$ 的 $n$ 最大是 15 ，并且 n 太大容易产生误差
- 已经有充分已知数据的情形下不适合再使用层次分析法，因为层次分析法的一个重要的过程是我们根据事实和资料来确定标度，在已有数据均已确定的情形下显然不再适合自行确定标度

### 2.8 步骤总结

1. 列出总目标层、准则层、方案层

2. 查找资料，填充准则层的判断矩阵
   - 对准则层的判断矩阵进行一致性检验，如不能通过应该调整矩阵的值直至通过
   - 利用三种方法求出准则层的权重向量 W

3. 查找资料，分别就各个准则层因素来填充方案层的判断矩阵
   - 对每个方案层的判断矩阵进行一致性检验，如不能通过应该调整矩阵的值直至通过
   - 利用三种方法求出每个方案层的权重向量 V

4. 将准则层的权重向量 W 和每个方案层的权重向量 V 列在一张表格中，进行最终分数评估

---

## （三）代码构建思路

### 文本文件格式设置如下：
```
请在下一行的开头分别输入准则层（先）和方案层（后）的规模（使用空格隔开）：
-----------------------------------------------------------------------
请在下面输入准则层矩阵
-----------------------------------------------------------------------
请在下面输入各个方案层的矩阵（注意顺序）
-----------------------------------------------------------------------
```

只需要按照格式输入即可，比如：
```
请在下一行的开头分别输入准则层（先）和方案层（后）的规模（使用空格隔开）：
5 3
-----------------------------------------------------------------------
请在下面输入准则层矩阵
1 0.5 4 3 3
2 1 8 6 6
0.25 0.125 1 0.875 0.875
0.333 0.167 1.333 1 1
0.333 0.167 1.333 1 1
-----------------------------------------------------------------------
请在下面输入各个方案层的矩阵（注意顺序）
1 2 4
0.5 1 2
0.25 0.5 1
1 0.333 0.125
3 1 0.333
8 3 1
1 1 3
1 1 3
0.333 0.333 1
1 3 4
0.333 1 1
0.25 1 1
1 1 0.25
1 1 0.25
4 4 1
-----------------------------------------------------------------------
```

### 代码文件已经附上详细注释

```m
clc, clear  % 清空当前的命令行窗口
inFile = fopen('ahpInput.txt','rt'); % 以只读方式打开文件

if (inFile == -1) % 如果文件无法打开则输出报错信息
    disp("无法打开文件！");
else
    disp('成功打开文件！');
end

fgetl(inFile); % 读取文字行

rowCnt = fscanf(inFile,'%d %d\n',[1,2]);

fgetl(inFile); % 读取分割行
fgetl(inFile); % 读取文字行

factor = rand(rowCnt(1,1),rowCnt(1,1));  % 定义准则层

for i = 1:rowCnt(1,1)
    for j = 1:rowCnt(1,1)
        factor(i,j) = fscanf(inFile ,'%f', [1,1]); % 读取准则层矩阵
        if (j == rowCnt(1,1))
            fscanf(inFile,'\n');
        end
    end
end

fgetl(inFile); % 读取分割行
fgetl(inFile); % 读取文字行

RI = [0,0,0.58,0.9,1.12,1.24,1.32,1.41,1.45,1.49,1.52,1.54,1.56,1.58,1.59]; % 定义随机平均一致性指标

[eigenvectors , eigenvalues] = eig(factor);  % 求出判断矩阵的所有特征值构成对角阵eigenvalues，以及所有特征向量构成矩阵eigenvectors
max_eigenvalue = max(diag(eigenvalues)); % 求出最大的特征向量
whichColumn = find(diag(eigenvalues) == max_eigenvalue); % 找出最大的特征值对应的特征向量在哪一列
weightVector = eigenvectors(:,whichColumn)/sum(eigenvectors(:,whichColumn)); % 将找到的特征向量进行归一化处理
disp("准则矩阵的权重向量是");
disp(weightVector');

CR0 = (max_eigenvalue - rowCnt(1,1))/(rowCnt(1,1) - 1)/RI(rowCnt(1,1));

if CR0 < 0.1
    disp(['准则层判断矩阵的 CR 值为', CR0, ',一致性达到标准' newline]);
else
    disp(['准则层判断矩阵的 CR 值为', CR0, ',一致性未达标准' newline]);
end

weightVector_plan = zeros(rowCnt(1,2),rowCnt(1,1));

for i = 1:rowCnt(1,1)
    
    plan = zeros(rowCnt(1,2),rowCnt(1,2));    % 定义方案层矩阵

    for j = 1:rowCnt(1,2)
        for k = 1:rowCnt(1,2)
            plan(j,k) = fscanf(inFile ,'%f',[1,1]);  % 逐行输入得到各各要素下的方案层矩阵
            if (k == rowCnt(1,1))
                fscanf(inFile,'\n');
            end
        end
    end

    [eigenvectors_plan , eigenvalues_plan] = eig(plan);  % 求出判断矩阵的所有特征值构成对角阵eigenvalues，以及所有特征向量构成矩阵eigenvectors
    max_eigenvalue_plan = max(diag(eigenvalues_plan)); % 求出最大的特征向量
    whichColumn2 = find(diag(eigenvalues_plan) == max_eigenvalue_plan); % 找出最大的特征值对应的特征向量在哪一列
    weightVector_plan(:,i) = eigenvectors_plan(:,whichColumn2)/sum(eigenvectors_plan(:,whichColumn2)); % 将找到的特征向量进行归一化处理
    disp(['因素', num2str(i) ,'对应的各方案判断矩阵的权重向量是']);
    disp(weightVector_plan(:,i)');
    
    CR1 = (max_eigenvalue_plan - rowCnt(1,2))/(rowCnt(1,2) - 1)/RI(rowCnt(1,2));

    if CR1 < 0.1
        disp(['因素', num2str(i), '各方案判断矩阵的 CR 值为', num2str(CR1), ',一致性达到标准' newline]);
    else
        disp(['因素', num2str(i), '各方案判断矩阵的 CR 值为', num2str(CR1), ',一致性未达标准' newline]);
    end
end

scores = zeros(rowCnt(1,2));

for i= 1:rowCnt(1,2)
    scores(i) = sum(weightVector_plan(i,:)'.*weightVector);
    disp(['方案', num2str(i) ,'的得分为' , num2str(scores(i))]);
end

fclose(inFile);
```
